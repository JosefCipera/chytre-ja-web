<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <title>Chytré Já - Ukázka Universa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        html,
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #111827;
            color: #d1d5db;
        }

        #knowledge-map {
            width: 100%;
            height: 100%;
        }

        /* Styly pro informační panel */
        #info-panel {
            position: absolute;
            top: 20px;
            right: -400px;
            width: 350px;
            max-height: calc(100vh - 40px);
            background-color: rgba(31, 41, 55, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: right 0.5s ease-in-out;
            color: #d1d5db;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        #info-panel.visible {
            right: 20px;
        }

        #info-content {
            padding: 25px;
        }

        #info-content h2 {
            margin-top: 0;
            font-size: 1.5rem;
            color: #ffffff;
        }

        #info-content p {
            line-height: 1.6;
        }

        #info-content a {
            color: #60A5FA;
            text-decoration: none;
        }

        #info-content a:hover {
            text-decoration: underline;
        }

        #info-content ul {
            padding-left: 20px;
            list-style-type: disc;
        }

        #info-content hr {
            border-color: #4b5563;
            margin: 1.5rem 0;
        }

        #close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
            border: none;
            background: none;
            z-index: 1001;
        }

        /* Styly pro úvodní splash screen */
        #splash-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #1f2937;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #d1d5db;
            font-size: 1.2rem;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            opacity: 1;
            transition: opacity 1s ease-in-out;
            z-index: 2000;
        }

        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #splash-screen h1 {
            font-size: 3rem;
            color: #ffffff;
            margin-bottom: 20px;
        }

        #splash-screen button {
            background-color: #2563EB;
            color: white;
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 30px;
            transition: background-color 0.3s ease;
        }

        #splash-screen button:hover {
            background-color: #3b82f6;
        }

        /* Styly pro tlačítka úloh v panelu */
        .task-button {
            background-color: #F59E0B;
            /* Oranžová pro úkoly */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 10px;
            display: inline-block;
            transition: background-color 0.3s ease;
        }

        .task-button:hover {
            background-color: #D97706;
        }

        /* Styly pro zobrazení obsahu článku */
        .article-view {
            padding: 20px;
            background-color: rgba(45, 55, 72, 0.95);
            border-radius: 8px;
            margin-top: 20px;
            color: #e2e8f0;
        }

        .article-view h2 {
            color: #ffffff;
            font-size: 1.3rem;
            margin-bottom: 15px;
        }

        .article-view p {
            margin-bottom: 10px;
        }

        .article-view ul {
            padding-left: 25px;
            list-style-type: disc;
        }

        .article-view a {
            color: #60A5FA;
        }

        .article-view button.task-button {
            margin-top: 15px;
        }

        .back-to-concept {
            margin-top: 20px;
            color: #60A5FA;
            cursor: pointer;
            text-decoration: underline;
        }

        .back-to-concept:hover {
            text-decoration: none;
        }

        /* Styly pro ikony v panelu */
        .concept-icon {
            margin-right: 10px;
            /* Barva bude převzata z termData.color inline stylem */
        }
    </style>
</head>

<body>
    <div id="knowledge-map"></div>

    <div id="info-panel">
        <button id="close-btn" onclick="hideInfoPanel()">&times;</button>
        <div id="info-content"></div>
    </div>

    <div id="splash-screen">
        <h1>Vítejte v Universu Myšlenek</h1>
        <p>Prozkoumejte síť klíčových konceptů. Klikněte na uzel pro detailní informace a související materiály.</p>
        <p>Můžete uzly přetahovat a přibližovat/oddalovat mapu.</p>
        <button onclick="hideSplashScreen()">Spustit Universum</button>
    </div>

    <script type="text/javascript">
        // --- Globální proměnné ---
        let contentData = {};
        let network = null;
        const nodes = new vis.DataSet([]);
        const edges = new vis.DataSet([]);

        const container = document.getElementById('knowledge-map');
        const infoPanel = document.getElementById('info-panel');
        const infoContent = document.getElementById('info-content');
        const splashScreen = document.getElementById('splash-screen');

        let currentConceptId = null;

        // --- Konfigurace VIS.js sítě ---
        const options = {
            nodes: {
                shape: 'icon',
                icon: {
                    face: 'Font Awesome 5 Free', // Zpět na přesný název fontu
                    weight: '900', // Důležité pro 'fas' (solid) ikony
                    size: 30,
                    color: '#ffffff',
                    // vadjust: -5 // Prozatím necháme bez vadjustu pro ikonu, spoléháme na font.vadjust
                },
                font: {
                    size: 14,
                    color: '#ffffff',
                    multi: 'html',
                    vadjust: -8 // Často potřebná korekce pro ikony v Canvasu
                },
                borderWidth: 2,
                shadow: true
            },
            edges: {
                width: 2,
                color: { color: '#4B5563', highlight: '#60A5FA' },
                arrows: { to: { enabled: false } },
                smooth: { type: 'dynamic' }
            },
            physics: { enabled: true, solver: 'barnesHut', barnesHut: { gravitationalConstant: -25000, centralGravity: 0.1, springLength: 180, damping: 0.09 } },
            interaction: { hover: true, tooltipDelay: 200, keyboard: true }
        };

        // --- Funkce pro ovládání UI (Panel, Splash Screen, Úlohy) ---
        function hideInfoPanel() {
            infoPanel.classList.remove('visible');
            currentConceptId = null;
        }

        function hideSplashScreen() {
            splashScreen.classList.add('hidden');
        }

        function runTask(taskId) {
            let taskUrl = '';
            switch (taskId) {
                case 'simulace-linky':
                    taskUrl = 'table-production.html';
                    break;
                case 'minidashboard':
                    taskUrl = 'minidashboard.html';
                    break;
                case 'nalezeni-omezeni':
                    alert('Spouštím kalkulačku: Nádytění kapacita');
                    break;
                case 'kalkulacka-prutoku':
                    alert('Spouštím kalkulačku průtoku');
                    break;
                case 'prehled-toc':
                    alert('Zobrazuji přehled TOC pro manažery');
                    break;
                case 'implementace-toc':
                    alert('Otevírám průvodce implementací TOC');
                    break;
                case 'analyza-zasob':
                    alert('Spouštím analýzu optimálních zásob');
                    break;
                case 'prirucka-5kroku':
                    alert('Otevírám průvodce 5 kroky zlepšování');
                    break;
                case 'dbn-simulace':
                    alert('Spouštím simulaci DBR systému');
                    break;
                case 'ccpm-uvod':
                    alert('Otevírám úvod do Critical Chain Project Management');
                    break;
                default:
                    console.warn(`Pro úlohu s ID "${taskId}" nebyla nalezena URL ani definovaná akce.`);
                    alert(`Úloha "${taskId}" zatím nemá definovanou URL ani akci.`);
                    return;
            }
            if (taskUrl) {
                window.open(taskUrl, '_blank');
            }
        }

        function showArticleDetail(articleId) {
            const article = contentData.library.find(item => item.id === articleId);
            if (article && article.content) {
                infoContent.innerHTML = `
                    <div class="article-view">
                        <h2>${article.title}</h2>
                        ${article.content}
                        <p class="back-to-concept" onclick="showConceptHub(currentConceptId)">← Zpět k detailu konceptu</p>
                    </div>
                `;
            } else {
                infoContent.innerHTML = `<h2>Chyba</h2><p>Obsah článku "${articleId}" nebyl nalezen.</p>`;
            }
            infoPanel.classList.add('visible');
        }

        function showConceptHub(termId) {
            currentConceptId = termId;

            let termData;
            let isSubnode = false;

            termData = contentData.dictionary.find(term => term.term === termId);

            if (!termData) {
                for (const mainTerm of contentData.dictionary) {
                    if (mainTerm.subnodes) {
                        const sub = mainTerm.subnodes.find(subnode => `${mainTerm.term}-${subnode.term}` === termId);
                        if (sub) {
                            termData = sub;
                            isSubnode = true;
                            break;
                        }
                    }
                }
            }

            if (!termData) {
                infoContent.innerHTML = `<h2>Nenalezeno</h2><p>Detailní data pro termín "${termId}" nebyla nalezena.</p>`;
                infoPanel.classList.add('visible');
                return;
            }

            const displayTerm = termData.term;

            const iconColor = termData.color || '#FBBF24';
            const iconHtml = termData.icon ? `<i class="fas fa-${getFaClassName(termData.icon)} concept-icon" style="color:${iconColor};"></i>` : '';

            let relatedContentHtml = '<h3>Související zdroje:</h3><ul>';
            let foundContent = false;

            if (!isSubnode && contentData.library) {
                contentData.library.forEach(item => {
                    const searchableText = `${item.title} ${item.description} ${item.tags ? item.tags.join(' ') : ''}`.toLowerCase();
                    const termNameLower = termData.term.toLowerCase();

                    const isDirectlyRelated = searchableText.includes(termNameLower);

                    let isIndirectlyRelated = false;
                    if (termData.relatedTerms && Array.isArray(termData.relatedTerms)) {
                        isIndirectlyRelated = termData.relatedTerms.some(rt => searchableText.includes(rt.toLowerCase()));
                    }

                    if (isDirectlyRelated || isIndirectlyRelated) {
                        if (item.type === 'Článek' || item.type === 'Případová studie' || item.type === 'E-book') {
                            relatedContentHtml += `<li><a href="#" onclick="showArticleDetail('${item.id}'); return false;">${item.title}</a> (${item.type})</li>`;
                        } else {
                            relatedContentHtml += `<li><a href="${item.url || '#'}" target="_blank">${item.title}</a> (${item.type})</li>`;
                        }
                        foundContent = true;
                    }
                });
            }
            if (!foundContent && !isSubnode) relatedContentHtml += '<li>Žádné specifické materiály nebyly nalezeny.</li>';
            if (isSubnode && !foundContent) relatedContentHtml = '';

            let tasksHtml = '';
            if (termData.tasks && Array.isArray(termData.tasks) && termData.tasks.length > 0) {
                tasksHtml = '<h3>Dostupné úlohy:</h3><div>';
                termData.tasks.forEach(task => {
                    tasksHtml += `<button class="task-button" onclick="runTask('${task.id}')">${task.name}</button>`;
                });
                tasksHtml += '</div><hr>';
            } else if (isSubnode && (!termData.tasks || termData.tasks.length === 0)) {
                tasksHtml = '<p>Pro tento podkoncept nejsou k dispozici žádné přímé úlohy.</p>';
            }


            infoContent.innerHTML = `
                <h2>${iconHtml}${displayTerm}</h2>
                <p>${termData.definition}</p>
                ${tasksHtml}
                ${!isSubnode && foundContent ? '<hr>' : ''} 
                ${!isSubnode ? relatedContentHtml : ''} 
            `;

            infoPanel.classList.add('visible');
        }

        // Pomocná funkce pro získání názvu třídy z Unicode pro HTML panel
        function getFaClassName(unicode) {
            const unicodeMap = {
                '\uf0eb': 'lightbulb',
                '\uf071': 'exclamation-triangle',
                '\uf085': 'cogs',
                '\uf201': 'chart-line',
                '\uf0e3': 'gavel',
                '\uf572': 'stream',
                '\uf468': 'boxes',
                '\uf0cb': 'list-ol',
                '\uf569': 'drum',
                '\uf542': 'project-diagram',
                '\uf0ae': 'tasks',
                '\uf518': 'book-open',
                '\uf0e8': 'sitemap'
            };
            return unicodeMap[unicode] || '';
        }

        fetch('./content.json')
            .then(response => {
                if (!response.ok) throw new Error('Soubor content.json nenalezen.');
                return response.json();
            })
            .then(data => {
                console.log("Data z content.json úspěšně načtena.");
                contentData = data;
                initializeNetwork();
            })
            .catch(error => {
                console.error('Chyba při načítání content.json:', error);
                alert('Nepodařilo se načíst data pro universum. Ujistěte se, že soubor content.json je ve stejné složce.');
            });

        function initializeNetwork() {
            nodes.clear();
            edges.clear();

            const termMap = new Map();
            contentData.dictionary.forEach(term => {
                termMap.set(term.term.toLowerCase(), term);
            });

            const tocTermData = contentData.dictionary.find(term => term.term === 'Teorie omezení') || { term: 'Teorie omezení', definition: 'Centrální koncept', color: '#2563EB', icon: '\uf0eb' };
            nodes.add({
                id: 'Teorie omezení',
                label: 'Teorie omezení\n(TOC)',
                color: tocTermData.color,
                size: 40,
                font: { color: 'white', size: 16 },
                icon: { code: tocTermData.icon, size: 40, color: tocTermData.color || '#ffffff' },
                fullData: tocTermData
            });

            contentData.dictionary.forEach(term => {
                if (term.term === 'Teorie omezení') return;

                nodes.add({
                    id: term.term,
                    label: term.term,
                    color: term.color || '#10B981',
                    size: 25,
                    font: { color: 'white', size: 14 },
                    icon: { code: term.icon, size: 30, color: term.color || '#ffffff' },
                    fullData: term
                });

                edges.add({ from: 'Teorie omezení', to: term.term });

                if (term.subnodes && Array.isArray(term.subnodes)) {
                    term.subnodes.forEach(subnode => {
                        const subnodeId = `${term.term}-${subnode.term}`;
                        nodes.add({
                            id: subnodeId,
                            label: subnode.term,
                            color: subnode.color || term.color,
                            size: 15,
                            font: { color: 'white', size: 12 },
                            icon: { code: subnode.icon, size: 20, color: subnode.color || term.color || '#ffffff' },
                            fullData: subnode
                        });
                        edges.add({ from: term.term, to: subnodeId, dashes: true, color: { color: term.color || '#A1A1AA', opacity: 0.8 } });
                    });
                }
            });

            contentData.dictionary.forEach(term => {
                if (term.relatedTerms && Array.isArray(term.relatedTerms)) {
                    term.relatedTerms.forEach(relatedTerm => {
                        const targetNodeExists = nodes.get(relatedTerm);
                        if (targetNodeExists && term.term !== relatedTerm) {
                            const existingEdges = edges.get({
                                filter: function (item) {
                                    return (item.from === term.term && item.to === relatedTerm) ||
                                        (item.from === relatedTerm && item.to === term.term);
                                }
                            });
                            if (existingEdges.length === 0) {
                                edges.add({ from: term.term, to: relatedTerm, dashes: true });
                            }
                        }
                    });
                }

                if (term.definition) {
                    termMap.forEach((otherTerm, otherTermNameLower) => {
                        if (term.term.toLowerCase() === otherTermNameLower || otherTermNameLower === 'teorie omezení') {
                            return;
                        }
                        const edgeExists = edges.get({
                            filter: function (item) {
                                return (item.from === term.term && item.to === otherTerm.term) ||
                                    (item.from === otherTerm.term && item.to === term.term);
                            }
                        }).length > 0;

                        if (term.definition.toLowerCase().includes(otherTermNameLower) && !edgeExists) {
                            edges.add({ from: term.term, to: otherTerm.term, color: { color: '#A1A1AA', opacity: 0.6 } });
                        }
                    });
                }
            });

            const data = { nodes: nodes, edges: edges };
            network = new vis.Network(container, data, options);

            network.on("click", function (params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    showConceptHub(nodeId);
                } else {
                    hideInfoPanel();
                }
            });
        }
    </script>
</body>

</html>