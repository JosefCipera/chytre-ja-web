<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plán Výroby</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .ok {
            background-color: #d4edda;
        }

        .error {
            background-color: #f8d7da;
        }

        #loading {
            display: none;
            margin-top: 10px;
            font-weight: bold;
        }

        button {
            margin-bottom: 10px;
            padding: 10px;
        }
    </style>
</head>

<body>
    <h1>Plán Výroby (načteno z Firebase)</h1>
    <button onclick="runDataCheck()">Spustit kontrolu dat</button>
    <div id="loading">Načítám data...</div>
    <table id="productionTable">
        <thead>
            <tr>
                <th>ID zakázky</th>
                <th>Název zakázky</th>
                <th>Vyrobit ks</th>
                <th>Odvedeno ks</th>
                <th>Zbývá ks</th>
                <th>Termín dodání</th>
                <th>Průběžná doba</th>
                <th>Typ zakázky</th>
                <th>Plán. ukončení</th>
                <th>Plán. zahájení</th>
                <th>Stav</th>
                <th>Skut. zahájení</th>
                <th>Skut. ukončení</th>
                <th>Čas. plnění (%)</th>
                <th>Zpoždění (dny)</th>
                <th>Důvod zpoždění</th>
                <th>Kontrola dat</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Inicializace Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAKREZsoBZkA1xOQ5ff3XDmiJ88nwSjeOk",
            authDomain: "chytre-ja-app.firebaseapp.com",
            projectId: "chytre-ja-app",
            storageBucket: "chytre-ja-app.firebasestorage.app",
            messagingSenderId: "65882611642",
            appId: "1:65882611642:web:53d82914aa07d6677d4783"
        };

        try {
            const app = initializeApp(firebaseConfig);
            console.log('Firebase inicializováno');
            const db = getFirestore(app);
            let allRows = [];

            // Funkce pro převod Timestamp na DD.MM.YYYY
            function formatTimestamp(timestamp) {
                if (!timestamp || !timestamp.toDate) return '';
                const date = timestamp.toDate();
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`; // Vrátí např. 01.10.2025
            }

            // Načtení dat z Firestore
            async function loadData() {
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';
                allRows = [];
                const loadingDiv = document.getElementById('loading');
                loadingDiv.innerText = 'Načítám data...';
                loadingDiv.style.display = 'block';

                try {
                    console.log('Načítám data z kolekce "productionOrders"');
                    const snapshot = await getDocs(collection(db, 'productionOrders'));
                    if (snapshot.empty) {
                        console.warn('Žádné dokumenty v kolekci productionOrders');
                        loadingDiv.innerText = 'Žádná data k zobrazení';
                        return;
                    }

                    snapshot.forEach(doc => {
                        console.log('Načtený dokument:', doc.id, doc.data());
                        const data = doc.data();
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${doc.id}</td>
                            <td>${data.nazevZakazky || ''}</td>
                            <td>${data.vyrobitKs || ''}</td>
                            <td>${data.odvedenoKs || ''}</td>
                            <td>${data.zbyvaKs || ''}</td>
                            <td>${formatTimestamp(data.terminDodani)}</td>
                            <td>${data.prubeznaDoba || ''}</td>
                            <td>${data.typZakazky || ''}</td>
                            <td>${formatTimestamp(data.planUkonceni)}</td>
                            <td>${formatTimestamp(data.planZahajeni)}</td>
                            <td>${data.stav || ''}</td>
                            <td>${formatTimestamp(data.skutZahajeni)}</td>
                            <td>${formatTimestamp(data.skutUkonceni)}</td>
                            <td>${data.casPlneni || ''}</td>
                            <td>${data.zpozdeniDny || ''}</td>
                            <td>${data.duvodZpozdeni || ''}</td>
                            <td class="kontrola-dat"></td>
                        `;
                        allRows.push({ id: doc.id, data, row });
                        tableBody.appendChild(row);
                    });
                    console.log('Načteno ' + allRows.length + ' řádků');
                    loadingDiv.innerText = 'Data načtena';
                } catch (error) {
                    console.error('Chyba při načítání dat:', error);
                    loadingDiv.innerText = 'Chyba při načítání dat: ' + error.message;
                } finally {
                    setTimeout(() => { loadingDiv.style.display = 'none'; }, 2000);
                }
            }

            // Funkce pro validaci
            async function runDataCheck() {
                const loadingDiv = document.getElementById('loading');
                loadingDiv.innerText = 'Provádím kontrolu dat...';
                loadingDiv.style.display = 'block';

                try {
                    const orders = allRows.map(item => ({
                        iDZakazky: item.id,
                        data: {
                            ...item.data,
                            terminDodani: formatTimestamp(item.data.terminDodani) || item.data.terminDodani
                        }
                    }));

                    console.log('Odesílám data na validaci:', orders);

                    const response = await fetch('https://validate-production-data-65882611642.europe-west3.run.app', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orders })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP chyba: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    console.log('Odpověď z validace:', result);

                    result.detailed_results.forEach(validationResult => {
                        const rowItem = allRows.find(r => r.id === validationResult.row_id);
                        if (rowItem) {
                            const kontrolaCell = rowItem.row.querySelector('.kontrola-dat');
                            kontrolaCell.innerText = validationResult.kontrola_dat;
                            if (validationResult.kontrola_dat === 'ok') {
                                kontrolaCell.classList.remove('error');
                                kontrolaCell.classList.add('ok');
                            } else {
                                kontrolaCell.classList.remove('ok');
                                kontrolaCell.classList.add('error');
                            }
                        } else {
                            console.error('Nenalezen řádek pro row_id:', validationResult.row_id);
                        }
                    });
                    loadingDiv.innerText = `Kontrola dokončena: ${result.summary.ok_rows} OK, ${result.summary.error_rows} chyb`;
                } catch (error) {
                    console.error('Chyba při kontrole dat:', error);
                    loadingDiv.innerText = `Chyba při validaci: ${error.message}`;
                } finally {
                    setTimeout(() => { loadingDiv.style.display = 'none'; }, 3000);
                }
            }

            // Přiřazení runDataCheck k globálnímu objektu
            window.runDataCheck = runDataCheck;

            // Načtení dat při načtení stránky
            loadData();
        } catch (error) {
            console.error('Chyba při inicializaci Firebase:', error);
            document.getElementById('loading').innerText = 'Chyba při inicializaci Firebase: ' + error.message;
        }
    </script>
</body>

</html>